(()=>{"use strict";console.log("Tomodachi Pets Content Script Injected!");let e,t,o=null,n=null,s=null,i=!0,l=[],a=0;function r(){o&&(o.remove(),o=null),c()}function c(){t&&clearInterval(t),t=void 0,e&&clearTimeout(e),e=void 0}function d(){o&&n&&l.length&&(a=0,m(l[a]))}function m(s){c(),o&&Array.from(o.querySelectorAll(".orbit-asset")).forEach((e=>e.remove()));const i=null==n?void 0:n.assets.find((e=>e.id===s.id));if(i){if("static"===s.mode){const e=document.createElement("img");e.src=i.url,e.className="orbit-asset",e.style.width="40px",e.style.height="40px",e.style.position="absolute",e.style.transform="translate(-50%, -50%)",null==o||o.appendChild(e),p([e])}else if("animated"===s.mode&&s.frameCount&&s.frameSize){const e=document.createElement("canvas");e.width=s.frameSize,e.height=s.frameSize,e.className="orbit-asset",e.style.width="40px",e.style.height="40px",e.style.position="absolute",e.style.transform="translate(-50%, -50%)",null==o||o.appendChild(e);const n=new window.Image;n.src=i.url,n.onload=()=>{let o=0;t=window.setInterval((()=>{!function(e,t,o,n){const s=t.getContext("2d");s.clearRect(0,0,n.frameSize,n.frameSize);const i=o%2*n.frameSize,l=Math.floor(o/2)*n.frameSize;s.drawImage(e,i,l,n.frameSize,n.frameSize,0,0,n.frameSize,n.frameSize)}(n,e,o,s),o=(o+1)%s.frameCount}),1e3/(s.frameRate||4))},p([e])}e=window.setTimeout((()=>{a=(a+1)%l.length,m(l[a])}),1e3*s.duration)}}function p(e){e.forEach((e=>{e.style.left="70px",e.style.top="0px"}))}function u(){if(r(),!n)return;const e=n,t=document.createElement("div");t.id="tomodachi-pet-container",t.style.position="fixed",t.style.zIndex="99999999",t.style.pointerEvents="none",t.style.transition="opacity 0.3s ease-in-out",t.style.opacity=i?"1":"0";let s=e.pet.imageUrl;if(s){const o=document.createElement("img");o.src=s,o.alt=e.pet.name,o.style.width="50px",o.style.height="50px",o.style.objectFit="contain",o.style.position="absolute",o.style.transform="translate(-50%, -50%)",t.appendChild(o)}else{const o=document.createElement("div");o.textContent=e.pet.name,o.style.color="black",o.style.backgroundColor="rgba(255,255,255,0.7)",o.style.padding="2px 5px",o.style.borderRadius="3px",o.style.position="absolute",o.style.transform="translate(-50%, -50%)",t.appendChild(o)}document.body.appendChild(t),o=t,l.length>0&&d()}function f(e){if(o&&i){const t=15,n=15;o.style.left=`${e.clientX+t}px`,o.style.top=`${e.clientY+n}px`}}function y(e,t){let a=!1;"local"===t&&e.petData&&(n=e.petData.newValue,a=!0),"local"===t&&e.orbitAssetConfig&&(l=e.orbitAssetConfig.newValue||[],a=!0),"local"===t&&e.suiAddress&&(s=e.suiAddress.newValue),a&&(i&&n?u():!n&&o&&r())}function g(){i=!i,o&&(o.style.opacity=i?"1":"0"),i&&!o&&n&&u(),chrome.storage.local.set({petCompanionVisible:i}),console.log("Pet companion visibility toggled: "+(i?"ON":"OFF"))}chrome.runtime.onMessage.addListener(((e,t,o)=>("PET_DATA_UPDATED"===e.type?(n=e.payload,i&&u(),o({status:"success"})):"PET_DATA_ERROR"===e.type?(n=null,r(),o({status:"error_received"})):"TOGGLE_VISIBILITY"===e.type&&(g(),o({status:"visibility_toggled",isVisible:i})),!0))),window.self===window.top&&chrome.storage.local.get(["petData","suiAddress","petCompanionVisible","orbitAssetConfig"],(e=>{e.suiAddress&&(s=e.suiAddress),e.petData&&(n=e.petData),"boolean"==typeof e.petCompanionVisible&&(i=e.petCompanionVisible),e.orbitAssetConfig&&(l=e.orbitAssetConfig),n&&i&&u(),document.addEventListener("mousemove",f),chrome.storage.onChanged.addListener(y)})),document.addEventListener("keydown",(e=>{e.ctrlKey&&e.shiftKey&&"P"===e.key&&(e.preventDefault(),g())}))})();